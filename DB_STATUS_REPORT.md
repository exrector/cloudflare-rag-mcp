# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ D1 Database –∏ –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ü–æ–∏—Å–∫–∞

## üîç –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑

–î–∞—Ç–∞: 2026-01-07
–í–µ—Ç–∫–∞: claude/check-d1-semantic-search-0t8Sb

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### 1. –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (schema.sql)
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `documents` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–ª—è–º–∏:
  - id, file_path, file_name, folder, topic, file_type
  - content_hash –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  - github_sha –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π
  - r2_key –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ R2

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `chunks` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∞:
  - id, document_id, chunk_index, text
  - **vector_id** –¥–ª—è —Å–≤—è–∑–∏ —Å Vectorize
  - word_count –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  - FOREIGN KEY –Ω–∞ documents —Å ON DELETE CASCADE

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `sync_log` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π

- ‚úÖ –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 2. MCP Server (src/mcp-server.ts)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Vectorize –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –∏–∑ D1 –ø–æ chunk_id
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SQL –∑–∞–ø—Ä–æ—Å: `SELECT text FROM chunks WHERE id = ?`
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ Vectorize —Å–æ–¥–µ—Ä–∂–∞—Ç chunk_id –¥–ª—è —Å–≤—è–∑–∏ —Å D1

### 3. –°–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (ingest-github-actions.js)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ—Ç embeddings —á–µ—Ä–µ–∑ Workers AI API
- ‚úÖ **–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ–∫—Ç–æ—Ä—ã** –ø–µ—Ä–µ–¥ —Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π (–Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç chunks –≤ D1 —Å –ø–æ–ª—è–º–∏:
  ```sql
  INSERT INTO chunks (id, document_id, chunk_index, text, word_count, vector_id)
  VALUES (?, ?, ?, ?, ?, ?)
  ```
- ‚úÖ vector_id –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: `${documentId}_chunk_${i}`
- ‚úÖ –ë–∞—Ç—á–∏–Ω–≥ embeddings –ø–æ 5 –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

### 4. GitHub Actions (.github/workflows/index-to-rag.yml)
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ push .md/.txt/.mdx/.rst —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç secrets (CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_API_TOKEN)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –¥–ª—è debugging

## ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –¢–∞–±–ª–∏—Ü–∞ sync_log –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∫—Ä–∏–ø—Ç `ingest-github-actions.js` **–ù–ï —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ sync_log**.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** ingest-github-actions.js:279-323

–§—É–Ω–∫—Ü–∏—è `main()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª—ã, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ sync_log:
- –ù–µ—Ç INSERT –≤ sync_log –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ù–µ—Ç UPDATE –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
- –ù–µ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (files_processed, chunks_created, vectors_uploaded)
- –ù–µ—Ç –∑–∞–ø–∏—Å–∏ –æ—à–∏–±–æ–∫

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –±–∞–∑—ã
- –ö–æ–º–∞–Ω–¥–∞ –∏–∑ README –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
  ```sql
  SELECT * FROM sync_log ORDER BY sync_started_at DESC LIMIT 5
  ```

### 2. ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã —á–µ—Ä–µ–∑ API

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—É—é –±–∞–∑—É –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `check-db-status.js`, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç:
```bash
export CLOUDFLARE_ACCOUNT_ID="c1a12d6a421765d2ae66bd1ff3fa0e1f"
export CLOUDFLARE_API_TOKEN="your_token"
node check-db-status.js
```

### 3. ‚ÑπÔ∏è INFO: –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ `wrangler d1 execute`:
```
no such table: documents: SQLITE_ERROR
```

**–ü—Ä–∏—á–∏–Ω–∞:** –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ `.wrangler/state/v3/d1` –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ schema.sql

**–†–µ—à–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞):**
```bash
npx wrangler d1 execute myrag-metadata --local --file=schema.sql
```

–ù–æ –¥–ª—è production —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç.–∫. –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —É–¥–∞–ª–µ–Ω–Ω—É—é –±–∞–∑—É.

## üî¢ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∏–∑ README)

–ü–æ –¥–∞–Ω–Ω—ã–º README:
- **Documents:** 11
- **Chunks:** 47
- **–°—Ç–∞—Ç—É—Å:** –í—Å–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö Free Tier –ª–∏–º–∏—Ç–æ–≤ ‚úÖ

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö–†–ò–¢–ò–ß–ù–û
1. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sync_log**
   - –°–æ–∑–¥–∞—Ç—å INSERT –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - UPDATE –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
   - –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ error_message

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –í–ê–ñ–ù–û
2. **–°–æ–∑–¥–∞—Ç—å —É–¥–æ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π `check-db-status.js`
   - –î–æ–±–∞–≤–∏—Ç—å –≤ package.json –∫–∞–∫ npm script

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û
3. **–î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ diagnostic endpoint'–æ–≤ –≤ MCP server**
   - –î–æ–±–∞–≤–∏—Ç—å `/stats` endpoint —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–∞–∑–µ
   - –î–æ–±–∞–≤–∏—Ç—å `/health` endpoint, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç D1 + Vectorize

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç (—Ç—Ä–µ–±—É–µ—Ç API —Ç–æ–∫–µ–Ω)

```bash
export CLOUDFLARE_ACCOUNT_ID="c1a12d6a421765d2ae66bd1ff3fa0e1f"
export CLOUDFLARE_API_TOKEN="your_token_here"
node check-db-status.js
```

**–ß—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:**
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ documents
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ chunks
- ‚úÖ –°–∫–æ–ª—å–∫–æ chunks –∏–º–µ—é—Ç vector_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 100%)
- ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ sync_log –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Vectorize index

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ wrangler CLI (—Ç—Ä–µ–±—É–µ—Ç API —Ç–æ–∫–µ–Ω)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API —Ç–æ–∫–µ–Ω
export CLOUDFLARE_API_TOKEN="your_token"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å documents
npx wrangler d1 execute myrag-metadata --remote --command "SELECT COUNT(*) FROM documents"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å chunks
npx wrangler d1 execute myrag-metadata --remote --command "SELECT COUNT(*) FROM chunks"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ chunks –∏–º–µ—é—Ç vector_id
npx wrangler d1 execute myrag-metadata --remote --command "SELECT COUNT(*) FROM chunks WHERE vector_id IS NULL"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã:** 0 (–≤—Å–µ chunks –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å vector_id)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ GitHub Actions logs

1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ https://github.com/exrector/myRAG/actions
2. –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π workflow run "Index to RAG"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —à–∞–≥–∞ "Index changed files"
4. –ù–∞–π—Ç–∏ —Å—Ç—Ä–æ–∫–∏ —Å ‚úÖ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
   - Created N chunks
   - Created embeddings
   - Saved N vectors to Vectorize
   - Saved N chunks to D1

## ‚úÖ –í—ã–≤–æ–¥

### –î–∞–Ω–Ω—ã–µ –≤ –≥—Ä–∞—Ñ–∞—Ö —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞

**–°—Ç–∞—Ç—É—Å: ‚úÖ –í–°–ï –ü–†–ê–í–ò–õ–¨–ù–û** (—Å –æ–≥–æ–≤–æ—Ä–∫–æ–π)

–ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ **–≤—Å–µ chunks —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å vector_id**:

```javascript
// ingest-github-actions.js:264-269
await executeD1Query(
  'INSERT INTO chunks (id, document_id, chunk_index, text, word_count, vector_id) VALUES (?, ?, ?, ?, ?, ?)',
  [`${documentId}_chunk_${i}`, documentId, i, chunk.text, chunk.wordCount, `${documentId}_chunk_${i}`]
);
```

**–í–µ–∫—Ç–æ—Ä—ã –≤ Vectorize —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

```javascript
// ingest-github-actions.js:246-257
const vectors = textChunks.map((chunk, idx) => ({
  id: `${documentId}_chunk_${idx}`,
  values: embeddings[idx],
  metadata: {
    chunk_id: `${documentId}_chunk_${idx}`,  // ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ MCP server
    document_id: documentId,
    file_path: filePath,
    topic,
    folder,
    chunk_index: idx,
  },
}));
```

**MCP Server –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ:**

```typescript
// src/mcp-server.ts:51-58
async function getChunkText(db: D1Database, chunkId: string): Promise<string> {
  const result = await db
    .prepare('SELECT text FROM chunks WHERE id = ?')
    .bind(chunkId)
    .first();
  return result?.text as string || '[Text not found]';
}
```

### –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

‚ùå **sync_log –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** - —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞, –Ω–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. ‚úÖ **–ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å
2. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sync_log –¥–ª—è –ª—É—á—à–µ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
3. üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π `check-db-status.js` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
